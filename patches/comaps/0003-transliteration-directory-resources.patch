From 60100b8431fb7079aa06e3857b234332b6dd6a24 Mon Sep 17 00:00:00 2001
From: GitHub Copilot <copilot@github.com>
Date: Fri, 19 Dec 2025 07:22:10 +0000
Subject: [PATCH] fix: transliteration loader for directory-based resources

When ResourcesDir points to a filesystem directory (not a ZIP file),
use direct file access instead of ZipFileReader::UnzipFile.

This enables the plugin to work with extracted assets rather than
requiring an APK ZIP file.
---
 libs/indexer/transliteration_loader.cpp | 26 ++++++++++++++++++++-----
 1 file changed, 21 insertions(+), 5 deletions(-)

diff --git a/libs/indexer/transliteration_loader.cpp b/libs/indexer/transliteration_loader.cpp
index 9ef60ab6..e268e86e 100644
--- a/libs/indexer/transliteration_loader.cpp
+++ b/libs/indexer/transliteration_loader.cpp
@@ -19,14 +19,30 @@ void InitTransliterationInstanceWithDefaultDirs()
   char const kICUDataFile[] = "icudt75l.dat";
   if (!pl.IsFileExistsByFullPath(base::JoinPath(pl.WritableDir(), kICUDataFile)))
   {
-    try
+    // Check if ResourcesDir is a directory (not a ZIP file)
+    std::string const resourcesDir = pl.ResourcesDir();
+    std::string const srcPath = base::JoinPath(resourcesDir, kICUDataFile);
+    
+    if (!ZipFileReader::IsZip(resourcesDir) && pl.IsFileExistsByFullPath(srcPath))
     {
-      ZipFileReader::UnzipFile(pl.ResourcesDir(), std::string("assets/") + kICUDataFile,
-                               pl.WritableDir() + kICUDataFile);
+      // ResourcesDir is a directory, use file directly from filesystem
+      LOG(LDEBUG, ("Using ICU data from directory:", srcPath));
+      // File already accessible in resourcesDir, use that path directly
+      Transliteration::Instance().Init(resourcesDir);
+      return;
     }
-    catch (RootException const & e)
+    else
     {
-      LOG(LWARNING, ("Can't get transliteration data file \"", kICUDataFile, "\", reason:", e.Msg()));
+      // ResourcesDir is a ZIP, extract the file
+      try
+      {
+        ZipFileReader::UnzipFile(resourcesDir, std::string("assets/") + kICUDataFile,
+                                 pl.WritableDir() + kICUDataFile);
+      }
+      catch (RootException const & e)
+      {
+        LOG(LWARNING, ("Can't get transliteration data file \"", kICUDataFile, "\", reason:", e.Msg()));
+      }
     }
   }
   Transliteration::Instance().Init(pl.WritableDir());
-- 
2.52.0

